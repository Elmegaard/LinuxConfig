Registry.require(["promise","helper","i18n","xmlhttprequest","permission"],function(){var e={DEFAULT:"default",OFF:"off",NATIVE:"native",CHROME:"chrome",NOT_ENABLED:"not_enabled",NOT_WHITELISTED:"not_whitelisted",NOT_PERMITTED:"not_permitted",NOT_SUPPORTED:"not_supported",NOT_SUCCEEDED:"not_succeeded"},p=rea.FEATURES,f=Registry.get("promise"),k=Registry.get("helper"),d=Registry.get("permission"),q=Registry.get("i18n"),x=Registry.get("xmlhttprequest").run,g=e.OFF,r=[],h=null,s=!1,l={},t=!1,u=function(){var a=
f();Registry.vendor(["vendor/saveas/filesaver"],function(){u=f.Pledge;a.resolve()});return a.promise()},m=function(){return null!==h?f.Pledge(h):d.has(d.permDownloads).then(function(a){h=a;console.log("downs: permission to use rea.downloads ->",a);return m()})},y=function(a,c){if(this[a])this[a]("function"==typeof c?c():c)},n=function(a,c){this[a]&&(y.apply(this,arguments),this[a]=null)},A=function(a,c,b){h&&!t&&p.DOWNLOAD.SUPPORTED&&(rea.downloads.onChanged.addListener(z),t=!0);b={filename:a.name,
body:a.data};["url","method","saveAs","headers"].forEach(function(c){b[c]=a[c]});rea.downloads.download(b,function(b){l[b]={callbacks:c,url:a.url,name:a.name}})},B=function(a,c,b){void 0===c&&(c={});void 0===b&&(b={});var e=function(){return n.apply(c,arguments)};a.responseType="blob";a.method=a.method||"GET";x(a,{onload:function(b){var c=b.responseHeaders?b.responseHeaders.split("\n"):null,d=null,f;for(f in c){var g=c[f].split(":"),h=g.shift()||"",g=g.join(":")||"";"content-type"==h.trim().toLowerCase()&&
(d=g.trim())}b=new Blob([b.response],{type:a.overrideMimeType||d||"binary/octet-stream"});saveAs(b,a.name);e("onload",{})},ondone:function(){e("ondone",{})},onerror:b.onerror,ontimeout:b.ontimeout,onprogress:b.onprogress})},z=function(a){var c=l[a.id];if(c){var b=c.callbacks,d=function(){return n.apply(b,arguments)};a.error?(console.warn("downs: download of",c.name,"("+c.url+")","failed",a.error),d("onerror",{error:e.NOT_SUCCEEDED,details:a.error})):a.endTime&&(console.debug("downs: download of",
c.name,"("+c.url+")","finished"),d("onload",{}),d("ondone",{}),delete l[a.id])}},v=function(a){var c=!1;k.each(r,function(b,d){if(b&&b.length)try{var e;if("/"===b[0])b=b.replace(/^\//g,"").replace(/\/$/g,""),"$"!==b[b.length-1]&&(console.log("downs: patching $ into",b),b+="$"),e=RegExp(b,"i");else if("."===b[0]){var g=[k.escapeForRegExp(b),"$"].join("");e=RegExp(g,"i")}else console.warn("downs: invalid file extension:",'"'+b+'"','starts neither with "." nor with "/"');if(e&&-1!==a.search(e))return console.log("downs:",
b,"matched @",a),c=!0}catch(f){console.warn("downs: can't process",b,f)}});return c},w=function(){return d.has(d.permDownloads).then(function(a){var c=f();s||a?c.resolve({permission:a,asked:!1}):d.ask(d.permDownloads,q.getMessage("Browser_API_Downloads"),q.getMessage("Click_here_to_allow_TM_to_start_downloads")).done(function(a){c.resolve({permission:a,asked:!0})});s=!0;return c.promise()})};Registry.register("downloads","3",{start:function(a,c,b){var d=this,f=arguments,h=function(){return n.apply(c,
arguments)};console.log("downs: start",a);g==e.OFF?(console.log("downs: feature is not enabled"),h("onerror",{error:e.NOT_ENABLED})):a.name&&v(a.name)?g==e.CHROME?p.DOWNLOAD.SUPPORTED?m().done(function(a){a?A.apply(d,f):(console.log("downs: download permission is missing"),h("onerror",{error:e.NOT_PERMITTED}))}):(console.log("downs: this download mode is not supported"),h("onerror",{error:e.NOT_SUPPORTED})):(a.name=a.name||"File.download",u().done(function(){B.apply(d,f)})):(console.log("downs:",
a.name,"is not whitelisted"),h("onerror",{error:e.NOT_WHITELISTED}))},set_mode:function(a){g=a;g==e.CHROME&&m().done(function(a){a||w().done(function(a){a.permission&&a.asked&&window.location.reload()})})},set_whitelist:function(a){"Array"===k.toType(a)&&(r=a)},is_whitelisted:v,request_permission:w,remove_permission:function(){return d.remove(d.permDownloads)},staticVars:e})});
